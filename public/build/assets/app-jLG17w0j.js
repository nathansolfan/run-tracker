document.addEventListener("DOMContentLoaded",function(){const P=new window.GPSSimulator;let m=null,S=null,u=!1,w=null,g=0,l=0,r=null,c=[],s=!1,f=null;const i=L.map("route-map").setView([40.7128,-74.006],14);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(i);let M=L.polyline([],{color:"blue",weight:4}).addTo(i);const p=[{latitude:40.7812,longitude:-73.9665},{latitude:40.7812,longitude:-73.9815},{latitude:40.7682,longitude:-73.9815},{latitude:40.7682,longitude:-73.9675}];p.forEach((t,e)=>{L.marker([t.latitude,t.longitude]).addTo(i).bindPopup(`Waypoint ${e+1}`)});const T=document.getElementById("start-tracking"),k=document.getElementById("stop-tracking"),$=document.getElementById("time-display"),b=document.getElementById("distance-display"),x=document.getElementById("pace-display"),D=document.getElementById("route-type"),d=document.getElementById("use-real-gps");d==null||d.addEventListener("change",function(){s=this.checked,s&&(navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{const e=[t.coords.latitude,t.coords.longitude];i.setView(e,16),L.marker(e).addTo(i).bindPopup("Your location").openPopup()},t=>{alert("Unable to access your location. Using simulation instead."),d.checked=!1,s=!1}):(alert("Geolocation is not supported by your browser"),d.checked=!1,s=!1))});function E(t,e,o,a){const y=(o-t)*Math.PI/180,n=(a-e)*Math.PI/180,B=Math.sin(y/2)*Math.sin(y/2)+Math.cos(t*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(n/2)*Math.sin(n/2);return 3958.8*(2*Math.atan2(Math.sqrt(B),Math.sqrt(1-B)))}function C(t){const e=Math.floor(t/3600),o=Math.floor(t%3600/60),a=t%60;return`${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}function I(){if(u){const t=Math.floor((Date.now()-w)/1e3)+g;if($.textContent=C(t),l>0){const e=Math.floor(t/l),o=Math.floor(e/60),a=Math.floor(e%60);x.textContent=`${o}:${a.toString().padStart(2,"0")}`}setTimeout(I,1e3)}}function v(){const t=D.value;let e;t==="path"&&p.length>0?(e={latitude:p[0].latitude,longitude:p[0].longitude},i.setView([e.latitude,e.longitude],14)):(e={latitude:40.7128,longitude:-74.006},i.setView([e.latitude,e.longitude],14)),m=P.simulate(e,{speed:3,mode:t,waypoints:p}),S=P.addListener(o=>{const a=[o.coords.latitude,o.coords.longitude];if(c.push(a),M.setLatLngs(c),i.panTo(a),r){const h=E(r.coords.latitude,r.coords.longitude,o.coords.latitude,o.coords.longitude);l+=h,b.textContent=l.toFixed(2)}r=o})}T.addEventListener("click",function(){u||(u=!0,w=Date.now(),T.disabled=!0,k.disabled=!1,c=[],M.setLatLngs([]),s?f=navigator.geolocation.watchPosition(t=>{const e=[t.coords.latitude,t.coords.longitude];if(c.push(e),M.setLatLngs(c),i.panTo(e),r){const o=E(r.coords.latitude,r.coords.longitude,t.coords.latitude,t.coords.longitude);l+=o,b.textContent=l.toFixed(2)}r={coords:{latitude:t.coords.latitude,longitude:t.coords.longitude}}},t=>{console.error("Error getting location",t),m||(alert("GPS tracking error. Falling back to simulation."),s=!1,d&&(d.checked=!1),v())},{enableHighAccuracy:!0,maximumAge:0,timeout:5e3}):v(),I())}),k.addEventListener("click",function(){if(!u)return;u=!1,g+=Math.floor((Date.now()-w)/1e3),T.disabled=!1,k.disabled=!0,s&&f!==null?(navigator.geolocation.clearWatch(f),f=null):m&&(m.stop(),S&&S());const t=new FormData;t.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),t.append("distance",l.toFixed(2));const e=Math.floor(g/3600),o=Math.floor(g%3600/60),a=g%60,h=`${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`;t.append("duration",h),t.append("date",new Date().toISOString().split("T")[0]);let y=s?"Tracked with real GPS":D.value==="path"?"Central Park Loop (simulated)":"Random Route (simulated)";t.append("notes",y),t.append("route_data",JSON.stringify(c)),fetch("/runs",{method:"POST",body:t}).then(n=>{if(n.redirected)window.location.href=n.url;else return n.json()}).then(n=>{n&&n.success&&(window.location.href="/runs")}).catch(n=>{console.error("Error:",n)})})});
