class ${constructor(o={}){this.options={updateInterval:1e3,accuracy:10,...o},this.listeners=[],this.intervalId=null}simulate(o,n={}){const g={...{mode:"random",speed:2.5,waypoints:[]},...n},l={coords:{latitude:o.latitude,longitude:o.longitude,accuracy:this.options.accuracy,altitude:null,altitudeAccuracy:null,heading:null,speed:g.speed},timestamp:Date.now()};return this.stop(),this.intervalId=setInterval(()=>{this._updatePosition(l,g),this._notifyListeners(l)},this.options.updateInterval),{isActive:()=>this.intervalId!==null,getCurrentPosition:()=>({...l}),stop:()=>this.stop()}}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}addListener(o){return this.listeners.push(o),()=>{const n=this.listeners.indexOf(o);n!==-1&&this.listeners.splice(n,1)}}_updatePosition(o,n){n.mode==="random"?(o.coords.latitude+=(Math.random()-.5)*1e-4*n.speed,o.coords.longitude+=(Math.random()-.5)*1e-4*n.speed):n.mode==="path"&&n.waypoints.length>0,o.timestamp=Date.now()}_notifyListeners(o){const n=JSON.parse(JSON.stringify(o));this.listeners.forEach(r=>r(n))}}window.GPSSimulator=$;document.addEventListener("DOMContentLoaded",function(){const M=new window.GPSSimulator;let o=null,n=null,r=!1,g=null,l=0,u=0,d=null,m=[],c=!1,f=null;const p=L.map("route-map").setView([40.7128,-74.006],14);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(p);let I=L.polyline([],{color:"blue",weight:4}).addTo(p);const y=[{latitude:40.7812,longitude:-73.9665},{latitude:40.7812,longitude:-73.9815},{latitude:40.7682,longitude:-73.9815},{latitude:40.7682,longitude:-73.9675}],v=document.getElementById("start-tracking"),P=document.getElementById("stop-tracking"),B=document.getElementById("time-display"),D=document.getElementById("distance-display"),C=document.getElementById("pace-display"),T=document.getElementById("route-type"),h=document.getElementById("use-real-gps");h==null||h.addEventListener("change",function(){c=this.checked,c&&(navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{const e=[t.coords.latitude,t.coords.longitude];p.setView(e,16)},t=>{alert("Unable to access your location. Using simulation instead."),h.checked=!1,c=!1}):(alert("Geolocation is not supported by your browser"),h.checked=!1,c=!1))});function E(t,e,a,s){const w=(a-t)*Math.PI/180,i=(s-e)*Math.PI/180,x=Math.sin(w/2)*Math.sin(w/2)+Math.cos(t*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 3958.8*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)))}function O(t){const e=Math.floor(t/3600),a=Math.floor(t%3600/60),s=t%60;return`${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}function k(){if(r){const t=Math.floor((Date.now()-g)/1e3)+l;if(B.textContent=O(t),u>0){const e=Math.floor(t/u),a=Math.floor(e/60),s=Math.floor(e%60);C.textContent=`${a}:${s.toString().padStart(2,"0")}`}setTimeout(k,1e3)}}function b(){const t=T.value;let e;t==="path"&&y.length>0?(e={latitude:y[0].latitude,longitude:y[0].longitude},p.setView([e.latitude,e.longitude],14)):(e={latitude:40.7128,longitude:-74.006},p.setView([e.latitude,e.longitude],14)),o=M.simulate(e,{speed:3,mode:t,waypoints:y}),n=M.addListener(a=>{const s=[a.coords.latitude,a.coords.longitude];if(m.push(s),I.setLatLngs(m),p.panTo(s),d){const S=E(d.coords.latitude,d.coords.longitude,a.coords.latitude,a.coords.longitude);u+=S,D.textContent=u.toFixed(2)}d=a})}v.addEventListener("click",function(){r||(r=!0,g=Date.now(),v.disabled=!0,P.disabled=!1,m=[],I.setLatLngs([]),c?f=navigator.geolocation.watchPosition(t=>{const e=[t.coords.latitude,t.coords.longitude];if(m.push(e),I.setLatLngs(m),p.panTo(e),d){const a=E(d.coords.latitude,d.coords.longitude,t.coords.latitude,t.coords.longitude);u+=a,D.textContent=u.toFixed(2)}d={coords:{latitude:t.coords.latitude,longitude:t.coords.longitude}}},t=>{console.error("Error getting location",t),o||(alert("GPS tracking error. Falling back to simulation."),c=!1,h&&(h.checked=!1),b())},{enableHighAccuracy:!0,maximumAge:0,timeout:5e3}):b(),k())}),P.addEventListener("click",function(){if(!r)return;r=!1,l+=Math.floor((Date.now()-g)/1e3),v.disabled=!1,P.disabled=!0,c&&f!==null?(navigator.geolocation.clearWatch(f),f=null):o&&(o.stop(),n&&n());const t=new FormData;t.append("_token",document.querySelector('meta[name="csrf-token"]').getAttribute("content")),t.append("distance",u.toFixed(2));const e=Math.floor(l/3600),a=Math.floor(l%3600/60),s=l%60,S=`${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;t.append("duration",S),t.append("date",new Date().toISOString().split("T")[0]);let w=c?"Tracked with real GPS":T.value==="path"?"Central Park Loop (simulated)":"Random Route (simulated)";t.append("notes",w),t.append("route_data",JSON.stringify(m)),fetch("/runs",{method:"POST",body:t}).then(i=>{if(i.redirected)window.location.href=i.url;else return i.json()}).then(i=>{i&&i.success&&(window.location.href="/runs")}).catch(i=>{console.error("Error:",i)})})});
